(function(){"use strict";function Timer(){const e=()=>{const e=new Date;return e.getMilliseconds()/1e3+e.getSeconds()+60*e.getMinutes()};return this.response=(t=null)=>{let a=e();this.globalTime=a,this.globalDeltaTime=a-this.oldTime,this.isPause?(this.localDeltaTime=0,this.pauseTime+=a-this.oldTime):(this.localDeltaTime=this.globalDeltaTime,this.localTime=a-this.pauseTime-this.startTime),this.frameCounter++,a-this.oldTimeFPS>3&&(this.FPS=this.frameCounter/(a-this.oldTimeFPS),this.oldTimeFPS=a,this.frameCounter=0,null!=t&&("string"==typeof t?document.getElementById(t).innerHTML=this.getFPS():t.innerHTML=this.getFPS())),this.oldTime=a},this.getFPS=()=>this.FPS.toFixed(3),this.globalTime=this.localTime=e(),this.globalDeltaTime=this.localDeltaTime=0,this.startTime=this.oldTime=this.oldTimeFPS=this.globalTime,this.frameCounter=0,this.isPause=!1,this.FPS=30,this.pauseTime=0,this}class Render{frameData=[-2,4,-2,4,0,0,0,0,.35,.03,.35,.03,0,1,0,0];frameUniformBufferIndex=5;frameScale=1;timer=new Timer;setColor=[0,0,1];constructor(canvas){this.canvas=canvas;let gl=this.canvas.getContext("webgl2");this.gl=gl;const loadShader=(e,t)=>{const a=gl.createShader(e);if(gl.shaderSource(a,t),gl.compileShader(a),!gl.getShaderParameter(a,gl.COMPILE_STATUS)){let e=gl.getShaderInfoLog(a);console.log("Shader compile fail: "+e)}return a};let vs_txt="#version 300 es\nprecision highp float;\nin vec3 InPosition;\n  \nout vec2 DrawPos;\nout vec4 DrawColor;\n\nuniform float Time;\nuniform vec3 SetColor;\n\nvoid main( void )\n{\n  gl_Position = vec4(InPosition, 1);\n  DrawPos = InPosition.xy;\n  DrawColor = vec4(SetColor, 1);\n}",fs_txt="#version 300 es\nprecision highp float;\nout vec4 OutColor;\n\nuniform FrameBuffer\n{  \n  vec4 BufData[4];\n};\n\nin vec2 DrawPos;\nin vec4 DrawColor;\n\nuniform float Time;\nvec2 mul( vec2 z1, vec2 z2 )\n{\n  return vec2(z1.x * z2.x - z1.y * z2.y, z1.x * z2.y + z1.y * z2.x);\n}\nfloat Jul( vec2 z, vec2 z0 )\n{\n  for (int i = 0; i < 256; i++)\n  {\n    if (dot(z, z) > 4.0)\n      return float(i);\n    z = mul(z, z) + z0;\n  }\n  return 256.0;\n}\nvec2 Rot( float A, vec2 v )\n{\n  return mat2(vec2(cos(A), -sin(A)), vec2(sin(A), cos(A))) * v;\n}\n\nvoid main( void )\n{\n  vec2 tp = (DrawPos + 1.0) / 2.0 * BufData[0].yw + BufData[0].xz;\n  vec2 p = Rot(Time * BufData[3].z * acos(-1.0) / 180.0, tp) * 1.0;\n  float c = Jul(p, vec2(BufData[2].x + BufData[2].y * sin(Time), BufData[2].z + BufData[2].w * sin(Time + BufData[3].x))) / 256.0;\n  OutColor = mod(DrawColor * c * BufData[3].y, vec4(1, 1, 1, 1));\n  OutColor.a = 1.0;\n}\n",vs=loadShader(gl.VERTEX_SHADER,vs_txt),fs=loadShader(gl.FRAGMENT_SHADER,fs_txt),prg=gl.createProgram();if(gl.attachShader(prg,vs),gl.attachShader(prg,fs),gl.linkProgram(prg),!gl.getProgramParameter(prg,gl.LINK_STATUS)){let e=gl.getProgramInfoLog(prg);console.log("Shader program link fail: "+e)}const size=1,vertexes=[-size,size,0,-size,-size,0,size,size,0,size,-size,0],posLoc=gl.getAttribLocation(prg,"InPosition");let vertexArray=gl.createVertexArray();gl.bindVertexArray(vertexArray);let vertexBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertexes),gl.STATIC_DRAW),-1!=posLoc&&(gl.vertexAttribPointer(posLoc,3,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(posLoc)),this.timeLoc=gl.getUniformLocation(prg,"Time"),this.colorLoc=gl.getUniformLocation(prg,"SetColor"),this.frameBuffer=gl.createBuffer(),gl.bindBuffer(gl.UNIFORM_BUFFER,this.frameBuffer),gl.bufferData(gl.UNIFORM_BUFFER,4*this.frameData.length,gl.STATIC_DRAW),gl.useProgram(prg),gl.uniformBlockBinding(prg,gl.getUniformBlockIndex(prg,"FrameBuffer"),this.frameUniformBufferIndex);let assoc={sl_CxB:["CxB",8],sl_CxS:["CxS",9],sl_CyB:["CyB",10],sl_CyS:["CyS",11],sl_Sh:["Sh",12],sl_Scl:["Scl",13],sl_Rot:["Rot",14]};this.canvas.parentNode.querySelectorAll(".slider").forEach((e=>{e.value=100*this.frameData[assoc[e.name][1]],e.parentNode.parentNode.querySelector("[name='"+e.name+"']").value=(e.value/100).toFixed(2),e.oninput=e=>{let t=assoc[e.target.name][0];e.target.parentNode.parentNode.querySelector("[name='"+t+"']").value=(e.target.value/100).toFixed(2),this.frameData[assoc[e.target.name][1]]=e.target.value/100}}));const reset=()=>{for(var e in this.frameData=[-2,4,-2,4,0,0,0,0,.35,.03,.35,.03,0,1,0,0],this.frameScale=1,this.setColor=[.3,.47,.8],assoc)this.canvas.parentNode.querySelector("[name='"+e+"']").value=100*this.frameData[assoc[e][1]],this.canvas.parentNode.querySelector("[name='"+assoc[e][0]+"']").value=this.frameData[assoc[e][1]];let t=this.canvas.parentNode.querySelector("sl_Col");if(null!=t){let e=(255*this.setColor[0]).toString(16).padStart(2,"0");g=(255*this.setColor[0]).toString(16).padStart(2,"0"),b=(255*this.setColor[0]).toString(16).padStart(2,"0"),t.value="#"+e+g+b}};let oldx,oldy;this.canvas.parentNode.querySelector(".pause").onclick=e=>{this.timer.isPause=!!e.target.checked},this.canvas.parentNode.querySelector(".reset").onclick=e=>{reset()},this.canvas.parentNode.querySelector("[name='sl_Col']").oninput=e=>{let tag=e.target,x=tag.value,r=eval("0x"+x[1]+x[2]),g=eval("0x"+x[3]+x[4]),b=eval("0x"+x[5]+x[6]);this.setColor=[r/255,g/255,b/255]},reset(),canvas.onmousemove=e=>{e.preventDefault(),1&e.buttons&&(this.frameData[0]-=this.frameData[1]*e.movementX/this.canvas.width,this.frameData[2]-=this.frameData[3]*-e.movementY/this.canvas.height)},canvas.ontouchstart=e=>{e.preventDefault(),e.touches.length>0&&(oldx=e.targetTouches[0].pageX-e.target.offsetLeft,oldy=e.targetTouches[0].pageY-e.target.offsetTop)},canvas.ontouchmove=e=>{if(e.preventDefault(),e.touches.length>0){let t=e.targetTouches[0].pageX-e.target.offsetLeft,a=e.targetTouches[0].pageY-e.target.offsetTop;this.frameData[0]-=this.frameData[1]*(t-oldx)/this.canvas.width,this.frameData[2]-=this.frameData[3]*-(a-oldy)/this.canvas.height,oldx=t,oldy=a}},canvas.onmousewheel=e=>{e.preventDefault();let t=(e.x-this.canvas.offsetLeft)/this.canvas.width,a=(this.canvas.height-1-(e.y-this.canvas.offsetTop))/this.canvas.height,r=t*this.frameData[1],o=a*this.frameData[3],s=e.wheelDelta;s<0?this.frameScale*=1.125*-s/120:s>0&&(this.frameScale/=1.125*s/120),this.frameData[1]=4*this.frameScale,this.frameData[3]=4*this.frameScale,this.frameData[0]-=t*this.frameData[1]-r,this.frameData[2]-=a*this.frameData[3]-o}}render(){this.timer.response(this.canvas.parentNode.querySelector(".fps"));const e=this.gl;e.clear(e.COLOR_BUFFER_BIT),e.bindBuffer(e.UNIFORM_BUFFER,this.frameBuffer),e.bufferData(e.UNIFORM_BUFFER,new Float32Array(this.frameData),e.STATIC_DRAW),e.bindBufferBase(e.UNIFORM_BUFFER,this.frameUniformBufferIndex,this.frameBuffer),-1!=this.timeLoc&&e.uniform1f(this.timeLoc,this.timer.localTime),-1!=this.colorLoc&&e.uniform3fv(this.colorLoc,new Float32Array(this.setColor)),e.drawArrays(e.TRIANGLE_STRIP,0,4)}mainLoop(){const e=()=>{this.render(),window.requestAnimationFrame(e)};e()}}window.addEventListener("load",(()=>{new Render(document.getElementById("myCan")).mainLoop(),document.querySelector("#clone").onclick=()=>{let e=document.querySelector(".group").cloneNode(!0);new Render(e.querySelector("canvas")).mainLoop(),document.body.append(e)}})),console.log("CGSG forever!!! main.js imported")})();
